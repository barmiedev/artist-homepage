---
import LanguageTranslations from '@/components/interactive/language-translation.svelte';
import Common from '@/layouts/common.astro';
import { getTrack } from '@/lib/content';
import { defaultLocale, getTranslations } from '@/lib/utils/i18n';
import { getLink } from '@/lib/utils/navigation';
import SimpleCard from '../cards/simple-card.astro';
import BackButton from '../interactive/back-button.svelte';
import PortableText from '../portable-text.astro';

const {
  props: { locale = defaultLocale, slug },
} = Astro;

const track = await getTrack({ slug: slug });
const t = await getTranslations(locale, 'track');
const backLink = await getLink({
  locale,
  tag: 'albums',
  slug: track?.album.slug,
});

const defaultLyricLanguage =
  import.meta.env.DEFAULT_LYRIC_LANGUAGE || defaultLocale;

const defaultLyrics = track?.lyrics?.find(
  (lyric) => lyric.language === defaultLyricLanguage,
);

console.log(track, defaultLocale);
---

<Common title={track?.title}>
  <BackButton client:load href={backLink}>{t.back}{track?.album.title}</BackButton>
  <h1>{track?.title}</h1>
  <div class="max-md:-mx-4">
  <SimpleCard class="w-full">
    {track && <LanguageTranslations client:visible track={track} labels={{ availableTranslations: t.availableTranslations, originalLyrics: t.originalLyrics, translation: t.translation}}>
      <article class="prose prose-stone prose-invert">
        <PortableText portableText={defaultLyrics?.text}/>
      </article>
      </LanguageTranslations>}
  </SimpleCard>
  </div>
</Common>